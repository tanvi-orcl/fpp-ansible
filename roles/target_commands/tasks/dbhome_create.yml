
- name: 'cswlib check bp'
  become: 'true'
  become_user: 'root'
  become_method: 'sudo'
  shell:  |
    {{ dbaascli_path }} cswlib list
  register: 'cswlib_list_result'
- debug:
    msg: '{{ cswlib_list_result }}'

- block:

  - name: 'cswlib download'
    become: 'true'
    become_user: 'root'
    become_method: 'sudo'
    shell:  |
      {{ dbaascli_path }} cswlib download --version {{ version | regex_replace("\.", "") }} --bp {{ dbhome_bp }}
    register: 'cswlib_download_result'
    failed_when: cswlib_download_result.stdout | regex_search("ERROR:.+")
  - debug:
      msg: '{{ cswlib_download_result }}'

  when: not cswlib_list_result.stdout | regex_search(dbhome_bp)

- name: 'create dbhome'
  become: 'true'
  become_user: 'root'
  become_method: 'sudo'
  shell:  |
    {{ dbaascli_path }} dbhome create --version {{ version | regex_replace("\.", "") }} --bp {{ dbhome_bp }} --ohome_name {{ dbhome_name }} --noprompt YES
  register: 'dbhome_create_result'
  failed_when: dbhome_create_result.stdout | regex_search("ERROR:.+")
- debug:
    msg: '{{ dbhome_create_result }}'

- name: 'DB Home Info'
  include_tasks: 'dbhome_info.yml'